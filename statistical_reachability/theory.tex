%\section{Probabilistic bounded reachability for hybrid systems with parametric uncertainty}
\section{Probabilistic bounded reachability}

\hide{
\subsection{Hybrid automata with parametric uncertainty}
We present a model for hybrid systems with probabilistic parameters using the framework of hybrid automata \cite{henzinger2000theory}. A hybrid automaton with parametric uncertainty introduces a finite number of random 
parameters with given distributions.
\begin{definition}
\label{def:ha}
{\rm(Hybrid Automata with Parametric Uncertainty)} A hybrid automaton with probabilistic parameters $H_p$ consists of the following components.

{\bf Variables}. A finite set $X = \{ x_1, \cdots, x_n \}$ of real-numbered variables, where $n$ is the dimension of $H_p$. We write $\dot{X}$ for the set $\{\dot{x_1}, \cdots, \dot{x_n}\}$ to represent first derivatives of variables during the continuous change, and write $X'$ for the set $\{x_1', \cdots, x_n'\}$ to denote values of variables at the conclusion of the discrete change.

{\bf Random Variables}. A finite set $Y = \{ y_1, \cdots, y_m \}$ of discrete and continuous random variables, and the corresponding distribution set $Distr=\{distr_1, \cdots,\\ distr_m\}$, where, for $0 \le i \le m$, $y_i$ has the corresponding distribution $distr_i$. These random variables are used to describe the system uncertainty caused by probabilistic parameters.

{\bf Control graph}. A finite directed multigraph $(V,E)$. The vertices in $V$ are called control modes, and edges in $E$ are control switches.

{\bf Initial, invariant, and flow conditions}. As vertex labeling functions over each control mode $v \in V$, the initial condition $init(v)$ is predicate whose free variables are from $V$, the invariant condition $inv(v)$ is a predicate whose free variables are from $X$, and the flow condition $flow(v)$ is a predicate whose free variables are from $X \cup \dot{X}$.

{\bf Jump conditions}. An edge labeling function $jump$ that assigns to each control switch $e \in E$ a predicate whose free variables are from $X \cup X'$.

{\bf Events}. A finite set $\Sigma$ of events, and an edge labeling function $event: E \to \Sigma$ that assigns to each control switch an event. 
 
\end{definition}

\subsection{Probabilistic bounded reachability}
With respect to system analysis, we are interested in the probability of reaching the target states within a bounded number of transition steps. We now formally state the probabilistic reachability problem for hybrid automata with parametric uncertainty. 

Let $H$ be a hybrid automaton without parametric uncertainty, and $H_p$ be a system of hybrid automata with parametric uncertainty as in Definition \ref{def:ha}. As for the set of random variables $Y_{H_p}$, let $\Omega_{H_p}$ be the corresponding sample space. we write $S$ as a random sampler with respect to the joint distribution of all random variables - $S: Y_{H_p} \to \omega_{H_p}$. For each sample $s_i$ generated by $S$, we write $H_{p}[s_i/Y_{H_p}]$ as the corresponding hybrid automaton without parametric uncertainty, where the set of random variables $Y_{H_p}$ has been replaced by their corresponding sampled values in $s_i$. Let $k \in N$ be a step bound, and $R_{H}^k$ denotes the set of all initialized trajectories of length $k$ of $H$. Also, we write $Goal$ be the set of target states.
\begin{remark}
\label{def:br}
{\rm (Bounded Reachability for Hybrid Automata)}
The bounded reachability problem for $H$ asks if there is a trace $\sigma \in R_{H}^k$ that visits the $Goal$.
\end{remark}
\begin{definition}
\label{def:pbr}
{\rm (Probabilistic Bounded Reachability for Hybrid Automata with Parametric Uncertainty)}\\
The probabilistic bounded reachability for $H_p$ estimates the maximum probability, over $\Omega_{H_p}$, of the bounded reachability for $H_{p}[s_i/Y_{H_p}]$, where $s_i \in S(Y_{H_p})$.
\end{definition}
}

% this should be said a bit earlier
%{\bf dReach} is a bounded reachability analyzer based on {\bf dReal} \cite{gao2013dreal}, and returns either unsat or $\delta$-sat for $M_i$. 

Let $RV$ be the set of probabilistic parameters for a probabilistic hybrid model $MP$, and $\phi$ a reachability
property. To solve the 
probabilistic bounded reachability problem, our method first samples the parameters in $RV$ according 
to their distributions. Then, for each sample $S_i$ we obtain a hybrid model $M_i$ without any probabilistic 
parameter. {\bf SReach} then calls {\bf dReach} \cite{gaodelta} with the desidered precision $\delta$ and 
unfolding steps $k$. {\bf dReach} returns either unsat or $\delta$-sat for $M_i$, and this information
is then used by a statistical test to decide whether stopping or repeat the entire procedure.
Algorithm \ref{fig:sreach} illustrates the main algorithm of our approach.
{\bf SReach} can be used to answer two types of questions: (1) Qualitative: Does $MP$ satisfy $\phi$ with probability
greater than a certain threshold? (2) Quantitative: What is the probability that $MP$ satisfies $\phi$?
Qualitative questions can be answered by hypothesis testing, while quantitative questions are addressed with
statistical estimation methods. Both methods produce answers up to some correctness 
precision that can be set arbitrarily by the user.
We have implemented in {\bf SReach} a number of statistical estimation and hypothesis testing techniques ---
more details can be found in Appendix \ref{apndx:stat}.

 
\hide{
With a sufficient number of sampled models, and a specified statistical testing method $ST$, {\bf SReach} terminates the entire procedure. It either returns the maximal probability of the system satisfying the given reachability property, or accepts or rejects according to the comparison whether the returned probability is larger (or smaller) than the specified threshold. 
}

\begin{algorithm}
  \centering
  \caption{SReach}
  \label{fig:sreach}
  \begin{algorithmic}[1]
    \Function{SReach}{$MP$, $ST$, $\delta$, $k$}
        \State $Succ \gets 0$	\Comment{number of $\delta$-sat samples}
        \State $N \gets 0$	\Comment{total number of samples}
        \State $RV \gets \mathrm{ExtractRV}(MP)$	\Comment{get the RVs from the probabilistic model}
        \Repeat
            \State $S_i \gets \mathrm{Sim}(RV)$		\Comment{sample the parameters}
            \State $M_i \gets \mathrm{Gen}(MP, S_i)$	\Comment{generate a dReach model}
            \State $Res \gets \mathrm{dReach}(M_i, \delta, k)$	\Comment{call dReach to solve $k$-step $\delta$-reachability}
            \If{$Res$ = $\delta$-sat}
            	%Good
		\State $Succ \gets Succ + 1$
%	  \Else
%	   	%Bad
%		\State $Fail \gets Fail + 1$
	    
	  \EndIf
	\State $N \gets N + 1$
        \Until{$ST.done(Succ, N)$}	\Comment{perform statistical test}\\
        %\State $Est\_prob \gets Succ / N$
	\quad\hspace{0.5ex} \Return $ST.output$
   \EndFunction
  \end{algorithmic}
\end{algorithm}

