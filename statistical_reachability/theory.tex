%\section{Probabilistic bounded reachability for hybrid systems with parametric uncertainty}
\section{Probabilistic bounded reachability}

Hybrid automata combine finite automata and dynamical systems~\cite{henzinger2000theory}. We can extend hybrid automata to allow probabilistic parameters in the following way. 

\begin{definition}
\label{def:ha}
{\rm(Hybrid Automata with Parametric Uncertainty)} A hybrid automaton with probabilistic parameters is a tuple $H_p = \langle Q,X,RX,\mathsf{jump},\mathsf{inv},\mathsf{init}\rangle$
with the following components. $X = \{x_1,...,x_n\}$ is a finite set of real variables and $Q=\{q_1,...,q_m\}$ a finite set of discrete modes. $RX = \{ u_1, \cdots, u_k \}$ is a finite set of random variables, where the distribution of $u_i$ is denoted by $P_i$. The other components are jumps, invariants, and initial condition predicates over $X\cup RX$, as standardly defined for hybrid automata.
\end{definition}
We write $\Omega_{RX_{H_p}}$ to be the sample space of the probabilistic parameters.
\begin{definition}
\label{def:pbr}
{\rm (Probabilistic Bounded Reachability)}
The probabilistic bounded reachability for $H_p$ estimates the maximum probability, over $\Omega_{RX_{H_p}}$, of the bounded reachability for $H_{p}[s_i/RX_{H_p}]$, where $s_i \in S(RX_{H_p})$.
\end{definition}
To solve probabilistic bounded reachability, we sample parameters in $RX$ according 
to their distributions and obtain a hybrid model $M_i$ with no probabilistic 
parameter. {\bf SReach} then calls {\bf dReach} \cite{gaodelta} with the desidered precision $\delta$ and 
unfolding steps $k$. {\bf dReach} returns either unsat or $\delta$-sat for $M_i$, and this information
is then used by statistical tests to decide whether stopping or repeat the procedure. The procedure is illustrated in Algorithm \ref{fig:sreach}. {\bf SReach} can answer two types of questions. 
\begin{itemize}
\item Does $MP$ satisfy $\phi$ with probability
greater than a certain threshold? 
\item What is the probability that $MP$ satisfies $\phi$?
\end{itemize}
These two types of questions can be answered by hypothesis testing, 
statistical estimation methods respectively. Both methods produce answers up to some correctness 
precision that can be set arbitrarily by the user.
We have implemented in {\bf SReach} a number of statistical estimation and hypothesis testing techniques including: {Lai's test}, {Bayes factor test}, {Bayes factor test with indifference region}, {Sequential probability ratio test (SPRT)}, {Chernoff-Hoeffding bound}, and Bayesian Interval Estimation with Beta prior. (See Appendix \ref{apndx:stat} for more details.) 
\begin{algorithm}
  \centering
  \caption{SReach}
  \label{fig:sreach}
  \begin{algorithmic}[1]
    \Function{SReach}{$MP$, $ST$, $\delta$, $k$}
        \State $Succ \gets 0$	\Comment{number of $\delta$-sat samples}
        \State $N \gets 0$	\Comment{total number of samples}
        \State $RV \gets \mathrm{ExtractRV}(MP)$	\Comment{get the RVs from the probabilistic model}
        \Repeat
            \State $S_i \gets \mathrm{Sim}(RV)$		\Comment{sample the parameters}
            \State $M_i \gets \mathrm{Gen}(MP, S_i)$	\Comment{generate a dReach model}
            \State $Res \gets \mathrm{dReach}(M_i, \delta, k)$	\Comment{call dReach to solve $k$-step $\delta$-reachability}
            \If{$Res$ = $\delta$-sat}
            	%Good
		\State $Succ \gets Succ + 1$
%	  \Else
%	   	%Bad
%		\State $Fail \gets Fail + 1$
	    
	  \EndIf
	\State $N \gets N + 1$
        \Until{$ST.done(Succ, N)$}	\Comment{perform statistical test}\\
        %\State $Est\_prob \gets Succ / N$
	\quad\hspace{0.5ex} \Return $ST.output$
   \EndFunction
  \end{algorithmic}
\end{algorithm}

